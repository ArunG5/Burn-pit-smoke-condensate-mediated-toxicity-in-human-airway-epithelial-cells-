{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "2d989d5d",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "── \u001b[1mAttaching core tidyverse packages\u001b[22m ──────────────────────── tidyverse 2.0.0 ──\n",
      "\u001b[32m✔\u001b[39m \u001b[34mdplyr    \u001b[39m 1.1.2     \u001b[32m✔\u001b[39m \u001b[34mreadr    \u001b[39m 2.1.4\n",
      "\u001b[32m✔\u001b[39m \u001b[34mforcats  \u001b[39m 1.0.0     \u001b[32m✔\u001b[39m \u001b[34mstringr  \u001b[39m 1.5.0\n",
      "\u001b[32m✔\u001b[39m \u001b[34mggplot2  \u001b[39m 3.4.2     \u001b[32m✔\u001b[39m \u001b[34mtibble   \u001b[39m 3.2.1\n",
      "\u001b[32m✔\u001b[39m \u001b[34mlubridate\u001b[39m 1.9.2     \u001b[32m✔\u001b[39m \u001b[34mtidyr    \u001b[39m 1.3.0\n",
      "\u001b[32m✔\u001b[39m \u001b[34mpurrr    \u001b[39m 1.0.1     \n",
      "── \u001b[1mConflicts\u001b[22m ────────────────────────────────────────── tidyverse_conflicts() ──\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n",
      "\u001b[36mℹ\u001b[39m Use the conflicted package (\u001b[3m\u001b[34m<http://conflicted.r-lib.org/>\u001b[39m\u001b[23m) to force all conflicts to become errors\n",
      "\n",
      "Attaching package: ‘reshape2’\n",
      "\n",
      "\n",
      "The following object is masked from ‘package:tidyr’:\n",
      "\n",
      "    smiths\n",
      "\n",
      "\n",
      "\n",
      "Attaching package: ‘rlang’\n",
      "\n",
      "\n",
      "The following objects are masked from ‘package:purrr’:\n",
      "\n",
      "    %@%, flatten, flatten_chr, flatten_dbl, flatten_int, flatten_lgl,\n",
      "    flatten_raw, invoke, splice\n",
      "\n",
      "\n",
      "Warning message in eval(expr, envir, enclos):\n",
      "“NAs introduced by coercion”\n",
      "Warning message in eval(expr, envir, enclos):\n",
      "“NAs introduced by coercion”\n"
     ]
    }
   ],
   "source": [
    "Output = c(\"/Users/alexis/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/CEMALB_DataAnalysisPM/Projects/P1011. Emission Mixtures/P1011.3. Analyses/P1011.3.3. Biomarker Distribution Analysis/Output\")\n",
    "cur_date = \"082823\"\n",
    "\n",
    "library(readxl)\n",
    "library(openxlsx)\n",
    "library(tidyverse)\n",
    "library(reshape2)\n",
    "library(rlang)\n",
    "library(PMCMRplus)\n",
    "\n",
    "# reading in files\n",
    "cytokine_df = data.frame(read_excel(\"Input/Processed_Cyotkine_Data_081723.xlsx\"))\n",
    "mRNA_df = data.frame(read_excel(\"Input/Processed_mRNA_Data_081723.xlsx\"))\n",
    "\n",
    "# making some cols numeric\n",
    "cytokine_df$Condensate_Conc = as.numeric(cytokine_df$Condensate_Conc)\n",
    "mRNA_df$Concentration = as.numeric(mRNA_df$Concentration)\n",
    "mRNA_df$Time_Point = as.numeric(mRNA_df$Time_Point)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "cbaca3a9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A data.frame: 6 × 7</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>Subject_ID</th><th scope=col>Subject_No</th><th scope=col>Cytokine</th><th scope=col>Condensate</th><th scope=col>Burn_Condition</th><th scope=col>Condensate_Conc</th><th scope=col>Norm_Cytokine_Conc</th></tr>\n",
       "\t<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>1</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>F</td><td> 1</td><td>5.438924</td></tr>\n",
       "\t<tr><th scope=row>2</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>F</td><td>25</td><td>3.630025</td></tr>\n",
       "\t<tr><th scope=row>3</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>F</td><td> 5</td><td>4.694272</td></tr>\n",
       "\t<tr><th scope=row>4</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>S</td><td> 1</td><td>6.165522</td></tr>\n",
       "\t<tr><th scope=row>5</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>S</td><td>25</td><td>3.703871</td></tr>\n",
       "\t<tr><th scope=row>6</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>S</td><td> 5</td><td>4.562595</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A data.frame: 6 × 7\n",
       "\\begin{tabular}{r|lllllll}\n",
       "  & Subject\\_ID & Subject\\_No & Cytokine & Condensate & Burn\\_Condition & Condensate\\_Conc & Norm\\_Cytokine\\_Conc\\\\\n",
       "  & <chr> & <dbl> & <chr> & <chr> & <chr> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t1 & F\\_1 & 1 & Eotaxin3 & C & F &  1 & 5.438924\\\\\n",
       "\t2 & F\\_1 & 1 & Eotaxin3 & C & F & 25 & 3.630025\\\\\n",
       "\t3 & F\\_1 & 1 & Eotaxin3 & C & F &  5 & 4.694272\\\\\n",
       "\t4 & F\\_1 & 1 & Eotaxin3 & C & S &  1 & 6.165522\\\\\n",
       "\t5 & F\\_1 & 1 & Eotaxin3 & C & S & 25 & 3.703871\\\\\n",
       "\t6 & F\\_1 & 1 & Eotaxin3 & C & S &  5 & 4.562595\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A data.frame: 6 × 7\n",
       "\n",
       "| <!--/--> | Subject_ID &lt;chr&gt; | Subject_No &lt;dbl&gt; | Cytokine &lt;chr&gt; | Condensate &lt;chr&gt; | Burn_Condition &lt;chr&gt; | Condensate_Conc &lt;dbl&gt; | Norm_Cytokine_Conc &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|\n",
       "| 1 | F_1 | 1 | Eotaxin3 | C | F |  1 | 5.438924 |\n",
       "| 2 | F_1 | 1 | Eotaxin3 | C | F | 25 | 3.630025 |\n",
       "| 3 | F_1 | 1 | Eotaxin3 | C | F |  5 | 4.694272 |\n",
       "| 4 | F_1 | 1 | Eotaxin3 | C | S |  1 | 6.165522 |\n",
       "| 5 | F_1 | 1 | Eotaxin3 | C | S | 25 | 3.703871 |\n",
       "| 6 | F_1 | 1 | Eotaxin3 | C | S |  5 | 4.562595 |\n",
       "\n"
      ],
      "text/plain": [
       "  Subject_ID Subject_No Cytokine Condensate Burn_Condition Condensate_Conc\n",
       "1 F_1        1          Eotaxin3 C          F               1             \n",
       "2 F_1        1          Eotaxin3 C          F              25             \n",
       "3 F_1        1          Eotaxin3 C          F               5             \n",
       "4 F_1        1          Eotaxin3 C          S               1             \n",
       "5 F_1        1          Eotaxin3 C          S              25             \n",
       "6 F_1        1          Eotaxin3 C          S               5             \n",
       "  Norm_Cytokine_Conc\n",
       "1 5.438924          \n",
       "2 3.630025          \n",
       "3 4.694272          \n",
       "4 6.165522          \n",
       "5 3.703871          \n",
       "6 4.562595          "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A data.frame: 6 × 8</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>Subject_No</th><th scope=col>Subject_ID</th><th scope=col>mRNA</th><th scope=col>Condensate</th><th scope=col>Burn_Condition</th><th scope=col>Concentration</th><th scope=col>Time_Point</th><th scope=col>Norm_ddCT</th></tr>\n",
       "\t<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>1</th><td>6</td><td>M_6</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td>24</td><td>3.912311</td></tr>\n",
       "\t<tr><th scope=row>2</th><td>5</td><td>F_5</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td> 4</td><td>3.067190</td></tr>\n",
       "\t<tr><th scope=row>3</th><td>1</td><td>F_1</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td> 4</td><td>3.843045</td></tr>\n",
       "\t<tr><th scope=row>4</th><td>2</td><td>M_2</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td> 4</td><td>3.415457</td></tr>\n",
       "\t<tr><th scope=row>5</th><td>3</td><td>M_3</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td> 4</td><td>3.234524</td></tr>\n",
       "\t<tr><th scope=row>6</th><td>4</td><td>F_4</td><td>HMOX1</td><td>PBS</td><td>PBS</td><td>NA</td><td> 4</td><td>3.294681</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A data.frame: 6 × 8\n",
       "\\begin{tabular}{r|llllllll}\n",
       "  & Subject\\_No & Subject\\_ID & mRNA & Condensate & Burn\\_Condition & Concentration & Time\\_Point & Norm\\_ddCT\\\\\n",
       "  & <dbl> & <chr> & <chr> & <chr> & <chr> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t1 & 6 & M\\_6 & HMOX1 & PBS & PBS & NA & 24 & 3.912311\\\\\n",
       "\t2 & 5 & F\\_5 & HMOX1 & PBS & PBS & NA &  4 & 3.067190\\\\\n",
       "\t3 & 1 & F\\_1 & HMOX1 & PBS & PBS & NA &  4 & 3.843045\\\\\n",
       "\t4 & 2 & M\\_2 & HMOX1 & PBS & PBS & NA &  4 & 3.415457\\\\\n",
       "\t5 & 3 & M\\_3 & HMOX1 & PBS & PBS & NA &  4 & 3.234524\\\\\n",
       "\t6 & 4 & F\\_4 & HMOX1 & PBS & PBS & NA &  4 & 3.294681\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A data.frame: 6 × 8\n",
       "\n",
       "| <!--/--> | Subject_No &lt;dbl&gt; | Subject_ID &lt;chr&gt; | mRNA &lt;chr&gt; | Condensate &lt;chr&gt; | Burn_Condition &lt;chr&gt; | Concentration &lt;dbl&gt; | Time_Point &lt;dbl&gt; | Norm_ddCT &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|---|\n",
       "| 1 | 6 | M_6 | HMOX1 | PBS | PBS | NA | 24 | 3.912311 |\n",
       "| 2 | 5 | F_5 | HMOX1 | PBS | PBS | NA |  4 | 3.067190 |\n",
       "| 3 | 1 | F_1 | HMOX1 | PBS | PBS | NA |  4 | 3.843045 |\n",
       "| 4 | 2 | M_2 | HMOX1 | PBS | PBS | NA |  4 | 3.415457 |\n",
       "| 5 | 3 | M_3 | HMOX1 | PBS | PBS | NA |  4 | 3.234524 |\n",
       "| 6 | 4 | F_4 | HMOX1 | PBS | PBS | NA |  4 | 3.294681 |\n",
       "\n"
      ],
      "text/plain": [
       "  Subject_No Subject_ID mRNA  Condensate Burn_Condition Concentration\n",
       "1 6          M_6        HMOX1 PBS        PBS            NA           \n",
       "2 5          F_5        HMOX1 PBS        PBS            NA           \n",
       "3 1          F_1        HMOX1 PBS        PBS            NA           \n",
       "4 2          M_2        HMOX1 PBS        PBS            NA           \n",
       "5 3          M_3        HMOX1 PBS        PBS            NA           \n",
       "6 4          F_4        HMOX1 PBS        PBS            NA           \n",
       "  Time_Point Norm_ddCT\n",
       "1 24         3.912311 \n",
       "2  4         3.067190 \n",
       "3  4         3.843045 \n",
       "4  4         3.415457 \n",
       "5  4         3.234524 \n",
       "6  4         3.294681 "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "head(cytokine_df)\n",
    "head(mRNA_df)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "aead4d48",
   "metadata": {},
   "source": [
    "# Research Question: Are there statistically significant differences in each biomarker between burn conditions? \n",
    "\n",
    "Starting by normalizing each burn condition to its control by calculating a fold change. Then using Wilcoxon rank sum tests to test for statistical differences by comparing an individual biomarker's value (ie. concentration or ddCT) between burn conditions (ie. smoldering and flaming) within each condensate (ie. plastic and cardboard), dose (only 1 and 25) and time point (only 24).\n",
    "\n",
    "# Calculating FC"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "d0bc2a56",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\u001b[1m\u001b[22mJoining with `by = join_by(Subject_ID, Subject_No, Cytokine)`\n",
      "\u001b[1m\u001b[22mJoining with `by = join_by(Subject_No, Subject_ID, mRNA, Time_Point)`\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A data.frame: 6 × 7</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>Subject_ID</th><th scope=col>Subject_No</th><th scope=col>Cytokine</th><th scope=col>Condensate</th><th scope=col>Burn_Condition</th><th scope=col>Dose</th><th scope=col>FC</th></tr>\n",
       "\t<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>1</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>F</td><td> 1</td><td>1.855742</td></tr>\n",
       "\t<tr><th scope=row>2</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>F</td><td>25</td><td>1.238552</td></tr>\n",
       "\t<tr><th scope=row>3</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>S</td><td> 1</td><td>2.103655</td></tr>\n",
       "\t<tr><th scope=row>4</th><td>F_1</td><td>1</td><td>Eotaxin3</td><td>C</td><td>S</td><td>25</td><td>1.263748</td></tr>\n",
       "\t<tr><th scope=row>5</th><td>M_2</td><td>2</td><td>Eotaxin3</td><td>C</td><td>F</td><td> 1</td><td>2.427278</td></tr>\n",
       "\t<tr><th scope=row>6</th><td>M_2</td><td>2</td><td>Eotaxin3</td><td>C</td><td>F</td><td>25</td><td>2.668766</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A data.frame: 6 × 7\n",
       "\\begin{tabular}{r|lllllll}\n",
       "  & Subject\\_ID & Subject\\_No & Cytokine & Condensate & Burn\\_Condition & Dose & FC\\\\\n",
       "  & <chr> & <dbl> & <chr> & <chr> & <chr> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t1 & F\\_1 & 1 & Eotaxin3 & C & F &  1 & 1.855742\\\\\n",
       "\t2 & F\\_1 & 1 & Eotaxin3 & C & F & 25 & 1.238552\\\\\n",
       "\t3 & F\\_1 & 1 & Eotaxin3 & C & S &  1 & 2.103655\\\\\n",
       "\t4 & F\\_1 & 1 & Eotaxin3 & C & S & 25 & 1.263748\\\\\n",
       "\t5 & M\\_2 & 2 & Eotaxin3 & C & F &  1 & 2.427278\\\\\n",
       "\t6 & M\\_2 & 2 & Eotaxin3 & C & F & 25 & 2.668766\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A data.frame: 6 × 7\n",
       "\n",
       "| <!--/--> | Subject_ID &lt;chr&gt; | Subject_No &lt;dbl&gt; | Cytokine &lt;chr&gt; | Condensate &lt;chr&gt; | Burn_Condition &lt;chr&gt; | Dose &lt;dbl&gt; | FC &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|\n",
       "| 1 | F_1 | 1 | Eotaxin3 | C | F |  1 | 1.855742 |\n",
       "| 2 | F_1 | 1 | Eotaxin3 | C | F | 25 | 1.238552 |\n",
       "| 3 | F_1 | 1 | Eotaxin3 | C | S |  1 | 2.103655 |\n",
       "| 4 | F_1 | 1 | Eotaxin3 | C | S | 25 | 1.263748 |\n",
       "| 5 | M_2 | 2 | Eotaxin3 | C | F |  1 | 2.427278 |\n",
       "| 6 | M_2 | 2 | Eotaxin3 | C | F | 25 | 2.668766 |\n",
       "\n"
      ],
      "text/plain": [
       "  Subject_ID Subject_No Cytokine Condensate Burn_Condition Dose FC      \n",
       "1 F_1        1          Eotaxin3 C          F               1   1.855742\n",
       "2 F_1        1          Eotaxin3 C          F              25   1.238552\n",
       "3 F_1        1          Eotaxin3 C          S               1   2.103655\n",
       "4 F_1        1          Eotaxin3 C          S              25   1.263748\n",
       "5 M_2        2          Eotaxin3 C          F               1   2.427278\n",
       "6 M_2        2          Eotaxin3 C          F              25   2.668766"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "dose_cytokine_df = cytokine_df %>%\n",
    "    rename(Dose = Condensate_Conc, Norm_Conc = Norm_Cytokine_Conc) %>%\n",
    "    filter(Dose %in% c(1, 25))\n",
    "\n",
    "dose_mRNA_df = mRNA_df %>%\n",
    "    rename(Dose = Concentration) %>%\n",
    "    filter(Dose %in% c(1, 25), Time_Point == 24)\n",
    "\n",
    "control_cytokine_df = cytokine_df %>%\n",
    "    rename(Dose = Condensate_Conc, Norm_Conc = Norm_Cytokine_Conc) %>%\n",
    "    filter(Dose %in% NA) %>%\n",
    "    select(-c(\"Condensate\", \"Burn_Condition\", \"Dose\")) %>%\n",
    "    rename(Control_Conc = Norm_Conc)\n",
    "\n",
    "control_mRNA_df = mRNA_df %>%\n",
    "    rename(Dose = Concentration) %>%\n",
    "    filter(Dose %in% NA, Time_Point == 24) %>%\n",
    "    select(-c(\"Condensate\", \"Burn_Condition\", \"Dose\")) %>%\n",
    "    rename(Control_ddCT = Norm_ddCT)\n",
    "\n",
    "# recombining for fold changes\n",
    "FC_cytokine_df = inner_join(dose_cytokine_df, control_cytokine_df) %>%\n",
    "    mutate(FC = Norm_Conc/Control_Conc) %>%\n",
    "    select(-c(\"Norm_Conc\", \"Control_Conc\"))\n",
    "\n",
    "FC_mRNA_df = inner_join(dose_mRNA_df, control_mRNA_df) %>%\n",
    "    mutate(FC = Norm_ddCT/Control_ddCT) %>%\n",
    "    select(-c(\"Norm_ddCT\", \"Control_ddCT\", \"Time_Point\"))\n",
    "\n",
    "head(FC_cytokine_df)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e479cae0",
   "metadata": {},
   "source": [
    "# Wilcoxon Ranks Sum Tests\n",
    "\n",
    "Testing for statistical differences between condensate and burn condition samples within each dose (either 1 or 25ug/mL)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "a646964c",
   "metadata": {},
   "outputs": [],
   "source": [
    "wilcox_condensate_test = function(df, biomarker, biomarker_name){\n",
    "    # \"\"\"\n",
    "    # Running wilcoxon rank sum tests after filtering for biomarker, burn condition, and dose using a loop. \n",
    "    # Ultimately using this test to compare condensates.\n",
    "\n",
    "    # :param: data frame, biomarker name, biomarker variable name\n",
    "    # :output: a data frame containing the biomarker, variable name, comparison, burn condition, concentration,\n",
    "    # stat, p value, p adj\n",
    "\n",
    "    # \"\"\"\n",
    "    # variables that will be iterated through\n",
    "    unique_biomarker = unique(df[[biomarker_name]])\n",
    "    unique_burn_condition = c(\"S\",\"F\")\n",
    "    unique_conc = unique(df$Dose)\n",
    "    \n",
    "    values_df = data.frame()\n",
    "    \n",
    "    # iterating through each biomarker, protein\n",
    "    for(i in 1:length(unique_conc)){\n",
    "        for(j in 1:length(unique_biomarker)){\n",
    "            for(k in 1:length(unique_burn_condition)){\n",
    "                \n",
    "                # plastic df\n",
    "                plastic_df = df %>%\n",
    "                    filter(eval(rlang::parse_expr(biomarker_name)) == unique_biomarker[j], Condensate == \"P\",\n",
    "                    Burn_Condition == unique_burn_condition[k], Dose == unique_conc[i])\n",
    "\n",
    "                # cardboard df\n",
    "                cardboard_df = df %>%\n",
    "                    filter(eval(rlang::parse_expr(biomarker_name)) == unique_biomarker[j], Condensate == \"C\",\n",
    "                    Burn_Condition == unique_burn_condition[k], Dose == unique_conc[i])\n",
    "\n",
    "                # wilcox test\n",
    "                wilcox_test = wilcox.test(plastic_df$FC, cardboard_df$FC)\n",
    "\n",
    "                # calculating FC to get directionality\n",
    "                #FC = log2(mean(cardboard_df$FC/mean(plastic_df$FC)))\n",
    "\n",
    "                # contains biomarker, name, comparison, burn conditon, dose, u stat, and p value\n",
    "                values_vector = cbind(biomarker, unique_biomarker[j], \"Plastic vs. Cardboard\", \n",
    "                                      unique_burn_condition[k], unique_conc[i], wilcox_test$statistic, \n",
    "                                      wilcox_test$p.value)\n",
    "                values_df = rbind(values_df, values_vector)\n",
    "            }\n",
    "        }\n",
    "    }\n",
    "\n",
    "    \n",
    "    # adding col names\n",
    "    colnames(values_df) = c(\"Biomarker\", \"Variable Name\", \"Comparison\", \"Burn Condition\", \"Dose\", \"Statistic\", \n",
    "                            \"P Value\")\n",
    "    \n",
    "    \n",
    "   # calculating padj values\n",
    "    values_df = values_df %>%\n",
    "        group_by(`Burn Condition`, Dose) %>%\n",
    "        mutate(`P Adj` = p.adjust(as.numeric(as.character(`P Value`)), method = \"fdr\"))\n",
    "    \n",
    "    return(values_df)\n",
    "}\n",
    "                                          \n",
    "# calling fn\n",
    "cytokine_condensate_df = wilcox_condensate_test(FC_cytokine_df, \"Cytokine\", \"Cytokine\")\n",
    "mRNA_condensate_df = wilcox_condensate_test(FC_mRNA_df, \"mRNA\", \"mRNA\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "cf7291ec",
   "metadata": {},
   "outputs": [],
   "source": [
    "wilcox_burn_conditon_test = function(df, biomarker, biomarker_name){\n",
    "    # \"\"\"\n",
    "    # Running wilcoxon rank sum tests after filtering for biomarker, condensate, and dose using a loop. \n",
    "    # Ultimately using this test to compare burn_conditons.\n",
    "\n",
    "    # :param: data frame, biomarker name, biomarker variable name\n",
    "    # :output: a data frame containing the biomarker, variable name, comparison, burn condition, concentration,\n",
    "    # stat, p value, p adj\n",
    "\n",
    "    # \"\"\"\n",
    "    # variables that will be iterated through\n",
    "    unique_biomarker = unique(df[[biomarker_name]])\n",
    "    unique_condensate = c(\"C\",\"P\")\n",
    "    unique_conc = unique(df$Dose)\n",
    "    \n",
    "    values_df = data.frame()\n",
    "    \n",
    "    # iterating through each biomarker, protein\n",
    "    for(i in 1:length(unique_conc)){\n",
    "        for(j in 1:length(unique_biomarker)){\n",
    "            for(k in 1:length(unique_condensate)){\n",
    "                \n",
    "                # smoldering df\n",
    "                smoldering_df = df %>%\n",
    "                    filter(eval(rlang::parse_expr(biomarker_name)) == unique_biomarker[j], Dose == unique_conc[i],\n",
    "                           Condensate == unique_condensate[k], Burn_Condition == \"S\")\n",
    "\n",
    "                # flaming df\n",
    "                flaming_df = df %>%\n",
    "                    filter(eval(rlang::parse_expr(biomarker_name)) == unique_biomarker[j], Dose == unique_conc[i],\n",
    "                           Condensate == unique_condensate[k], Burn_Condition == \"F\")\n",
    "\n",
    "                # wilcox test\n",
    "                wilcox_test = wilcox.test(smoldering_df$FC, flaming_df$FC)\n",
    "\n",
    "                # calculating FC to get directionality\n",
    "                #FC = log2(mean(flaming_df$FC/mean(smoldering_df$FC)))\n",
    "\n",
    "                # contains biomarker, name, comparison, condensate, dose, u stat, and p value\n",
    "                values_vector = cbind(biomarker, unique_biomarker[j], \"Smoldering vs. Flaming\", \n",
    "                                      unique_condensate[k], unique_conc[i], wilcox_test$statistic, \n",
    "                                      wilcox_test$p.value)\n",
    "                values_df = rbind(values_df, values_vector)\n",
    "            }\n",
    "        }\n",
    "    }\n",
    "\n",
    "    \n",
    "    # adding col names\n",
    "    colnames(values_df) = c(\"Biomarker\", \"Variable Name\", \"Comparison\", \"Condensate\", \"Dose\", \"Statistic\", \n",
    "                            \"P Value\")\n",
    "    \n",
    "    \n",
    "   # calculating padj values\n",
    "    values_df = values_df %>%\n",
    "        group_by(Condensate, Dose) %>%\n",
    "        mutate(`P Adj` = p.adjust(as.numeric(as.character(`P Value`)), method = \"fdr\"))\n",
    "    \n",
    "    return(values_df)\n",
    "}\n",
    "                                          \n",
    "# calling fn\n",
    "cytokine_burn_condition_df = wilcox_burn_conditon_test(FC_cytokine_df, \"Cytokine\", \"Cytokine\")\n",
    "mRNA_burn_condition_df = wilcox_burn_conditon_test(FC_mRNA_df, \"mRNA\", \"mRNA\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "75cd2247",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A grouped_df: 6 × 8</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>Biomarker</th><th scope=col>Variable Name</th><th scope=col>Comparison</th><th scope=col>Burn Condition</th><th scope=col>Dose</th><th scope=col>Statistic</th><th scope=col>P Value</th><th scope=col>P Adj</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>Cytokine</td><td>Eotaxin3</td><td>Plastic vs. Cardboard</td><td>S</td><td>1</td><td>20</td><td>0.818181818181818</td><td>0.9958063</td></tr>\n",
       "\t<tr><td>Cytokine</td><td>Eotaxin3</td><td>Plastic vs. Cardboard</td><td>F</td><td>1</td><td>15</td><td>0.699134199134199</td><td>0.9272727</td></tr>\n",
       "\t<tr><td>Cytokine</td><td>GMCSF   </td><td>Plastic vs. Cardboard</td><td>S</td><td>1</td><td>19</td><td>0.937229437229437</td><td>0.9958063</td></tr>\n",
       "\t<tr><td>Cytokine</td><td>GMCSF   </td><td>Plastic vs. Cardboard</td><td>F</td><td>1</td><td>19</td><td>0.937229437229437</td><td>0.9958063</td></tr>\n",
       "\t<tr><td>Cytokine</td><td>IL10    </td><td>Plastic vs. Cardboard</td><td>S</td><td>1</td><td>23</td><td>0.484848484848485</td><td>0.9958063</td></tr>\n",
       "\t<tr><td>Cytokine</td><td>IL10    </td><td>Plastic vs. Cardboard</td><td>F</td><td>1</td><td>22</td><td>0.588744588744589</td><td>0.9272727</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A grouped\\_df: 6 × 8\n",
       "\\begin{tabular}{llllllll}\n",
       " Biomarker & Variable Name & Comparison & Burn Condition & Dose & Statistic & P Value & P Adj\\\\\n",
       " <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <chr> & <dbl>\\\\\n",
       "\\hline\n",
       "\t Cytokine & Eotaxin3 & Plastic vs. Cardboard & S & 1 & 20 & 0.818181818181818 & 0.9958063\\\\\n",
       "\t Cytokine & Eotaxin3 & Plastic vs. Cardboard & F & 1 & 15 & 0.699134199134199 & 0.9272727\\\\\n",
       "\t Cytokine & GMCSF    & Plastic vs. Cardboard & S & 1 & 19 & 0.937229437229437 & 0.9958063\\\\\n",
       "\t Cytokine & GMCSF    & Plastic vs. Cardboard & F & 1 & 19 & 0.937229437229437 & 0.9958063\\\\\n",
       "\t Cytokine & IL10     & Plastic vs. Cardboard & S & 1 & 23 & 0.484848484848485 & 0.9958063\\\\\n",
       "\t Cytokine & IL10     & Plastic vs. Cardboard & F & 1 & 22 & 0.588744588744589 & 0.9272727\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A grouped_df: 6 × 8\n",
       "\n",
       "| Biomarker &lt;chr&gt; | Variable Name &lt;chr&gt; | Comparison &lt;chr&gt; | Burn Condition &lt;chr&gt; | Dose &lt;chr&gt; | Statistic &lt;chr&gt; | P Value &lt;chr&gt; | P Adj &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|\n",
       "| Cytokine | Eotaxin3 | Plastic vs. Cardboard | S | 1 | 20 | 0.818181818181818 | 0.9958063 |\n",
       "| Cytokine | Eotaxin3 | Plastic vs. Cardboard | F | 1 | 15 | 0.699134199134199 | 0.9272727 |\n",
       "| Cytokine | GMCSF    | Plastic vs. Cardboard | S | 1 | 19 | 0.937229437229437 | 0.9958063 |\n",
       "| Cytokine | GMCSF    | Plastic vs. Cardboard | F | 1 | 19 | 0.937229437229437 | 0.9958063 |\n",
       "| Cytokine | IL10     | Plastic vs. Cardboard | S | 1 | 23 | 0.484848484848485 | 0.9958063 |\n",
       "| Cytokine | IL10     | Plastic vs. Cardboard | F | 1 | 22 | 0.588744588744589 | 0.9272727 |\n",
       "\n"
      ],
      "text/plain": [
       "  Biomarker Variable Name Comparison            Burn Condition Dose Statistic\n",
       "1 Cytokine  Eotaxin3      Plastic vs. Cardboard S              1    20       \n",
       "2 Cytokine  Eotaxin3      Plastic vs. Cardboard F              1    15       \n",
       "3 Cytokine  GMCSF         Plastic vs. Cardboard S              1    19       \n",
       "4 Cytokine  GMCSF         Plastic vs. Cardboard F              1    19       \n",
       "5 Cytokine  IL10          Plastic vs. Cardboard S              1    23       \n",
       "6 Cytokine  IL10          Plastic vs. Cardboard F              1    22       \n",
       "  P Value           P Adj    \n",
       "1 0.818181818181818 0.9958063\n",
       "2 0.699134199134199 0.9272727\n",
       "3 0.937229437229437 0.9958063\n",
       "4 0.937229437229437 0.9958063\n",
       "5 0.484848484848485 0.9958063\n",
       "6 0.588744588744589 0.9272727"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# creating 1 df\n",
    "final_condensate_df = rbind(cytokine_condensate_df, mRNA_condensate_df)\n",
    "final_burn_condition_df = rbind(cytokine_burn_condition_df, mRNA_burn_condition_df)\n",
    "\n",
    "head(final_condensate_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "5f81bdb2",
   "metadata": {},
   "outputs": [],
   "source": [
    "# exporting\n",
    "write.xlsx(final_condensate_df, paste0(Output,\"/\", \"Wilcoxon_Condensate_Results_\", cur_date, \".xlsx\"), \n",
    "           rowNames = FALSE)\n",
    "write.xlsx(final_burn_condition_df, paste0(Output,\"/\", \"Wilcoxon_Burn_Condition_Results_\", cur_date, \".xlsx\"), \n",
    "           rowNames = FALSE)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3c121282",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "R",
   "language": "R",
   "name": "ir"
  },
  "language_info": {
   "codemirror_mode": "r",
   "file_extension": ".r",
   "mimetype": "text/x-r-source",
   "name": "R",
   "pygments_lexer": "r",
   "version": "4.1.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
